<!doctype html>
<html lang="th">

<head>
    <meta charset="utf-8" />
    <title>MeowClinic · Service / Equipment</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-50 min-h-screen">
    <div class="flex">
        <aside id="sidebar" class="w-64 shrink-0 border-r bg-white"></aside>

        <main class="flex-1 p-6 space-y-6">
            <div class="flex items-center justify-between">
                <h1 class="text-2xl font-bold">อุปกรณ์การแพทย์</h1>
                <button id="btnNew" class="px-3 py-2 bg-blue-600 text-white rounded-lg text-sm">+ เพิ่มอุปกรณ์</button>
            </div>

            <div class="bg-white border rounded-xl p-4">
                <div id="cards" class="grid md:grid-cols-2 xl:grid-cols-3 gap-4"></div>
            </div>

            <dialog id="dlg" class="modal">
                <form method="dialog" class="modal-box max-w-lg">
                    <h3 class="font-semibold text-lg mb-3">เพิ่ม/แก้ไข อุปกรณ์</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <input id="eqCode" class="input" placeholder="รหัส">
                        <input id="eqName" class="col-span-2 input" placeholder="ชื่ออุปกรณ์">
                        <input id="eqQty" type="number" class="input" placeholder="จำนวน">
                        <select id="eqStatus" class="input">
                            <option>พร้อมใช้งาน</option>
                            <option>ชำรุด</option>
                            <option>ส่งซ่อม</option>
                        </select>
                    </div>
                    <div class="mt-4 flex justify-end gap-2">
                        <button class="btn" value="cancel">ยกเลิก</button>
                        <button id="btnSave" class="px-3 py-2 bg-blue-600 text-white rounded-lg">บันทึก</button>
                    </div>
                </form>
            </dialog>
        </main>
    </div>

    <script src="js/app.js"></script>
    <script src="js/data.js"></script>
    <script>
        (async function () {
            await DB.ready();
            renderSidebar('service');

            const cards = document.getElementById('cards');
            let editingId = null;

            const render = () => {
                const { services } = DB.get();
                cards.innerHTML = services.map(s => `
          <div class="border rounded-xl bg-white p-4">
            <div class="font-semibold text-lg mb-1">${s.name}</div>
            <div class="text-sm">รหัส: ${s.id}</div>
            <div class="text-sm">จำนวน: ${s.qty}</div>
            <div class="text-sm">สถานะ: <span class="px-2 py-0.5 rounded text-xs ${s.status === 'พร้อมใช้งาน' ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-800'}">${s.status}</span></div>
            <div class="mt-3 flex gap-2">
              <button data-edit="${s.id}" class="btn">แก้ไข</button>
              <button data-del="${s.id}" class="px-3 py-1.5 rounded-lg bg-rose-600 text-white text-sm">ลบ</button>
            </div>
          </div>
        `).join('') || `<div class="text-slate-500">ยังไม่มีข้อมูล</div>`;
            };

            render();

            document.getElementById('btnNew').onclick = () => {
                editingId = null;
                dlg.showModal();
                eqCode.value = '';
                eqName.value = '';
                eqQty.value = '';
                eqStatus.value = 'พร้อมใช้งาน';
            };

            cards.addEventListener('click', e => {
                const id = e.target.dataset.edit || e.target.dataset.del;
                if (!id) return;
                if (e.target.dataset.edit) {
                    const s = DB.get().services.find(x => x.id === id);
                    editingId = id;
                    dlg.showModal();
                    eqCode.value = s.id;
                    eqName.value = s.name;
                    eqQty.value = s.qty;
                    eqStatus.value = s.status;
                } else if (e.target.dataset.del) {
                    if (confirm('ลบรายการนี้?')) {
                        DB.update(db => { db.services = db.services.filter(x => x.id !== id); });
                        render();
                    }
                }
            });

            btnSave.onclick = (ev) => {
                ev.preventDefault();
                const rec = { id: eqCode.value.trim(), name: eqName.value.trim(), qty: +eqQty.value || 0, status: eqStatus.value };
                if (!rec.id || !rec.name) return alert('กรอกรหัสและชื่อให้ครบ');
                DB.update(db => {
                    const i = db.services.findIndex(x => x.id === rec.id);
                    if (i >= 0) db.services[i] = rec;
                    else db.services.push(rec);
                });
                dlg.close();
                render();
            };
        })();
    </script>
</body>

</html>